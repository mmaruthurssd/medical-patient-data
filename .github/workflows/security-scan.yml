name: Security Scan (PHI & Credentials)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch: # Allow manual triggering

jobs:
  security-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write  # To create issues for violations
      pull-requests: write  # To comment on PRs

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for accurate diffs

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install security scanning dependencies
        run: |
          npm install -g gitleaks
          # Note: PHI scanning will use built-in patterns

      - name: Scan for credentials with Gitleaks
        id: gitleaks
        continue-on-error: true
        run: |
          echo "üîç Scanning for exposed credentials..."
          gitleaks detect \
            --source . \
            --verbose \
            --report-format json \
            --report-path gitleaks-report.json \
            --no-git \
            --exit-code 1

      - name: Scan for PHI patterns
        id: phi-scan
        continue-on-error: true
        run: |
          echo "üîç Scanning for Protected Health Information (PHI)..."

          # Create PHI detection script
          cat > scan-phi.sh << 'EOFSCRIPT'
          #!/bin/bash

          PHI_FOUND=0

          # Patterns for PHI detection (18 HIPAA identifiers)
          declare -A PHI_PATTERNS=(
            ["SSN"]="[0-9]{3}-[0-9]{2}-[0-9]{4}"
            ["MRN"]="(MRN|Medical Record|Patient ID)[\s:]*[A-Z0-9-]{5,15}"
            ["DOB"]="(DOB|Date of Birth|Birth Date)[\s:]*[0-9]{1,2}[/-][0-9]{1,2}[/-][0-9]{2,4}"
            ["PHONE"]="(\([0-9]{3}\)|[0-9]{3})[\s.-]?[0-9]{3}[\s.-]?[0-9]{4}"
            ["EMAIL_PHI"]="(patient|medical|health).*@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}"
          )

          echo "Scanning for PHI patterns..."
          for pattern_name in "${!PHI_PATTERNS[@]}"; do
            pattern="${PHI_PATTERNS[$pattern_name]}"
            matches=$(grep -rE "$pattern" . \
              --exclude-dir=node_modules \
              --exclude-dir=.git \
              --exclude-dir=dist \
              --exclude-dir=build \
              --exclude="*.md" \
              --exclude="*.log" \
              2>/dev/null || true)

            if [ -n "$matches" ]; then
              echo "‚ö†Ô∏è  PHI Pattern Found: $pattern_name"
              echo "$matches" | head -5
              PHI_FOUND=1
            fi
          done

          if [ $PHI_FOUND -eq 1 ]; then
            echo "‚ùå PHI patterns detected!"
            exit 1
          else
            echo "‚úÖ No PHI patterns detected"
            exit 0
          fi
          EOFSCRIPT

          chmod +x scan-phi.sh
          ./scan-phi.sh

      - name: Check gitignore coverage
        id: gitignore-check
        run: |
          echo "üîç Verifying sensitive files are gitignored..."

          # Check if critical patterns are in .gitignore
          MISSING_PATTERNS=()

          REQUIRED_PATTERNS=(
            "configuration/"
            "*.key"
            "*.pem"
            "service-account*.json"
            ".env"
            "*.phi"
          )

          for pattern in "${REQUIRED_PATTERNS[@]}"; do
            if ! grep -q "$pattern" .gitignore; then
              MISSING_PATTERNS+=("$pattern")
            fi
          done

          if [ ${#MISSING_PATTERNS[@]} -gt 0 ]; then
            echo "‚ö†Ô∏è  Missing .gitignore patterns:"
            printf '  - %s\n' "${MISSING_PATTERNS[@]}"
            echo "missing_patterns=true" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ All required patterns in .gitignore"
            echo "missing_patterns=false" >> $GITHUB_OUTPUT
          fi

      - name: Summarize scan results
        if: always()
        run: |
          echo "======================================================================"
          echo "  SECURITY SCAN SUMMARY"
          echo "======================================================================"
          echo ""

          if [ "${{ steps.gitleaks.outcome }}" == "failure" ]; then
            echo "‚ùå CREDENTIAL SCAN: FAILED"
            echo "   ‚Üí Exposed credentials detected by Gitleaks"
            echo "   ‚Üí Review gitleaks-report.json for details"
          else
            echo "‚úÖ CREDENTIAL SCAN: PASSED"
          fi

          if [ "${{ steps.phi-scan.outcome }}" == "failure" ]; then
            echo "‚ùå PHI SCAN: FAILED"
            echo "   ‚Üí Protected Health Information detected"
            echo "   ‚Üí Review scan output above for locations"
          else
            echo "‚úÖ PHI SCAN: PASSED"
          fi

          if [ "${{ steps.gitignore-check.outputs.missing_patterns }}" == "true" ]; then
            echo "‚ö†Ô∏è  GITIGNORE: INCOMPLETE"
            echo "   ‚Üí Some security patterns missing from .gitignore"
          else
            echo "‚úÖ GITIGNORE: COMPLETE"
          fi

          echo ""
          echo "======================================================================"

      - name: Upload Gitleaks report
        if: always() && steps.gitleaks.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: gitleaks-report.json
          retention-days: 30

      - name: Comment on PR with scan results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const credentialScan = '${{ steps.gitleaks.outcome }}';
            const phiScan = '${{ steps.phi-scan.outcome }}';
            const gitignoreCheck = '${{ steps.gitignore-check.outputs.missing_patterns }}';

            let status = '‚úÖ PASSED';
            let details = [];

            if (credentialScan === 'failure') {
              status = '‚ùå FAILED';
              details.push('üîê **Credential Scan**: ‚ùå Exposed credentials detected');
            } else {
              details.push('üîê **Credential Scan**: ‚úÖ No credentials detected');
            }

            if (phiScan === 'failure') {
              status = '‚ùå FAILED';
              details.push('üè• **PHI Scan**: ‚ùå Protected Health Information detected');
            } else {
              details.push('üè• **PHI Scan**: ‚úÖ No PHI detected');
            }

            if (gitignoreCheck === 'true') {
              details.push('‚ö†Ô∏è **Gitignore**: Missing security patterns');
            } else {
              details.push('üìã **Gitignore**: ‚úÖ All patterns present');
            }

            const comment = `## üîí Security Scan Results: ${status}\n\n${details.join('\n')}\n\n---\n*Automated HIPAA compliance check*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Fail workflow if violations found
        if: steps.gitleaks.outcome == 'failure' || steps.phi-scan.outcome == 'failure'
        run: |
          echo "‚ùå Security scan failed! Violations must be resolved before merging."
          exit 1
