name: Daily Sheet Snapshots

on:
  schedule:
    # Run at 9:00 AM PST (5:00 PM UTC)
    - cron: '0 17 * * *'
    # Run at 5:00 PM PST (1:00 AM UTC next day)
    - cron: '0 1 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  snapshot-production:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # For pushing commits
      issues: write    # For creating failure notifications
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for commits

      # Skip setup-node - use pre-installed Node.js on runner (avoids cache lookup issue)
      - name: Verify Node.js version
        run: node --version && npm --version

      - name: Install dependencies
        working-directory: Implementation Projects/google-sheets-version-control
        run: npm ci

      - name: Set up service account credentials
        run: |
          mkdir -p ~/service-account-keys
          echo '${{ secrets.GCP_SERVICE_ACCOUNT }}' > ~/service-account-keys/google-sheets-vc.json
          chmod 600 ~/service-account-keys/google-sheets-vc.json

      - name: Record workflow start time
        id: start_time
        run: echo "start=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Run production snapshot (Batch 1/3)
        id: batch1
        continue-on-error: true
        working-directory: Implementation Projects/google-sheets-version-control
        env:
          GOOGLE_APPLICATION_CREDENTIALS: /home/runner/service-account-keys/google-sheets-vc.json
          BATCH_SIZE: 135
          BATCH_OFFSET: 0
        run: npm run snapshot

      - name: Run production snapshot (Batch 2/3)
        id: batch2
        continue-on-error: true
        working-directory: Implementation Projects/google-sheets-version-control
        env:
          GOOGLE_APPLICATION_CREDENTIALS: /home/runner/service-account-keys/google-sheets-vc.json
          BATCH_SIZE: 135
          BATCH_OFFSET: 135
        run: npm run snapshot

      - name: Run production snapshot (Batch 3/3)
        id: batch3
        continue-on-error: true
        working-directory: Implementation Projects/google-sheets-version-control
        env:
          GOOGLE_APPLICATION_CREDENTIALS: /home/runner/service-account-keys/google-sheets-vc.json
          BATCH_SIZE: 135
          BATCH_OFFSET: 270
        run: npm run snapshot

      - name: Run staging snapshot
        working-directory: Implementation Projects/google-sheets-version-control
        env:
          GOOGLE_APPLICATION_CREDENTIALS: /home/runner/service-account-keys/google-sheets-vc.json
        run: npm run snapshot:staging

      - name: Check for changes
        id: check_changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push snapshots
        if: steps.check_changes.outputs.changes == 'true'
        working-directory: .
        run: |
          git config user.name "SSD Snapshot Bot"
          git config user.email "automation@ssdspc.com"
          git add "Implementation Projects/google-sheets-version-control/production-sheets/"
          git add "Implementation Projects/google-sheets-version-control/config/"
          [ -d "Implementation Projects/google-sheets-version-control/staging-sheets" ] && git add "Implementation Projects/google-sheets-version-control/staging-sheets/" || true
          git commit -m "chore: automated snapshot $(date '+%Y-%m-%d %H:%M:%S')"
          git pull --rebase origin main
          git push

      - name: Log snapshot run to Google Sheet
        if: always()
        working-directory: Implementation Projects/google-sheets-version-control
        env:
          GOOGLE_APPLICATION_CREDENTIALS: /home/runner/service-account-keys/google-sheets-vc.json
          GCP_SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT }}
        run: |
          # Calculate duration in minutes
          END_TIME=$(date +%s)
          START_TIME=${{ steps.start_time.outputs.start }}
          DURATION=$(( ($END_TIME - $START_TIME) / 60 ))

          # Determine overall status
          if [ "${{ steps.batch1.outcome }}" == "success" ] && \
             [ "${{ steps.batch2.outcome }}" == "success" ] && \
             [ "${{ steps.batch3.outcome }}" == "success" ]; then
            STATUS="SUCCESS"
          elif [ "${{ steps.batch1.outcome }}" == "cancelled" ] || \
               [ "${{ steps.batch2.outcome }}" == "cancelled" ] || \
               [ "${{ steps.batch3.outcome }}" == "cancelled" ]; then
            STATUS="CANCELLED"
          else
            STATUS="FAILURE"
          fi

          # Count batch successes (each batch processes 135 sheets, last batch 134)
          BATCH1_SUCCESS=0
          BATCH2_SUCCESS=0
          BATCH3_SUCCESS=0
          TOTAL_FAILURES=0

          if [ "${{ steps.batch1.outcome }}" == "success" ]; then
            BATCH1_SUCCESS=135
          else
            TOTAL_FAILURES=$((TOTAL_FAILURES + 135))
          fi

          if [ "${{ steps.batch2.outcome }}" == "success" ]; then
            BATCH2_SUCCESS=135
          else
            TOTAL_FAILURES=$((TOTAL_FAILURES + 135))
          fi

          if [ "${{ steps.batch3.outcome }}" == "success" ]; then
            BATCH3_SUCCESS=134
          else
            TOTAL_FAILURES=$((TOTAL_FAILURES + 134))
          fi

          # Determine notes based on status
          if [ "$STATUS" == "SUCCESS" ]; then
            NOTES="All batches completed successfully"
          elif [ "$STATUS" == "CANCELLED" ]; then
            NOTES="Workflow was cancelled"
          else
            NOTES="One or more batches failed - see GitHub run for details"
          fi

          # Log to Google Sheet
          node scripts/log-snapshot-run.js \
            "$STATUS" \
            "404" \
            "$BATCH1_SUCCESS" \
            "$BATCH2_SUCCESS" \
            "$BATCH3_SUCCESS" \
            "$TOTAL_FAILURES" \
            "$DURATION" \
            "${{ github.run_id }}" \
            "${{ github.sha }}" \
            "$NOTES"

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '‚ùå Daily snapshot failed',
              body: 'Automated snapshot workflow failed. Please check the logs.',
              labels: ['automated', 'snapshot', 'failed']
            })
