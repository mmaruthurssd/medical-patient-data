# GitHub Actions Daily Snapshot - Authentication Fix Summary

## Date
November 10, 2025

## Problem
The GitHub Actions daily snapshot workflow was consistently failing with OAuth authentication errors. The workflow would fail immediately or within minutes when trying to execute `clasp pull` commands to snapshot Google Apps Script code from 404 production sheets.

## Root Cause
The clasp authentication credentials from `~/.clasprc.json` were only being written to the home directory (`~/.clasprc.json`) in the GitHub Actions workflow. However, clasp in certain CI/CD environments also requires credentials to be present in the project root directory (`.clasprc.json`).

## Error Symptoms

### Initial Error
```
Error retrieving access token: TypeError: Cannot read properties of undefined (reading 'access_token')
```

This error occurred immediately on the first sheet being processed, indicating clasp couldn't properly access or read the credentials file.

## Solution

### Primary Fix: Write Credentials to Both Locations
Updated `.github/workflows/daily-snapshots.yml` to write the `CLASP_CREDENTIALS` secret to both:
1. Home directory: `~/.clasprc.json` (for global clasp access)
2. Project directory: `.clasprc.json` (for local project access)

**Changes in workflow (commit 665ed55):**
```yaml
- name: Set up clasp credentials
  run: |
    mkdir -p ~/.config/clasp
    echo '${{ secrets.CLASP_CREDENTIALS }}' > ~/.clasprc.json
    echo '${{ secrets.CLASP_CREDENTIALS }}' > .clasprc.json  # Added this line
    chmod 600 ~/.clasprc.json .clasprc.json                  # Added this line
```

### Secondary Fix: Handle Missing Staging Directory
The git commit step was failing because it tried to add `staging-sheets/` directory which doesn't exist (no staging sheets are configured yet).

**Changes in workflow (commit c473c5a):**
```yaml
- name: Commit and push snapshots
  if: steps.check_changes.outputs.changes == 'true'
  run: |
    git config user.name "SSD Snapshot Bot"
    git config user.email "automation@ssdspc.com"
    git add production-sheets/ config/
    [ -d staging-sheets ] && git add staging-sheets/ || true  # Conditional add
    git commit -m "chore: automated snapshot $(date '+%Y-%m-%d %H:%M:%S')"
    git push
```

## Test Results

### Test Run 1 (Workflow Run ID: 19246034764)
- **Duration:** 23 minutes 9 seconds
- **Status:** Failed (but authentication worked!)
- **Results:**
  - ✅ Batch 1/3 (135 sheets): 0 failures
  - ✅ Batch 2/3 (135 sheets): 0 failures
  - ✅ Batch 3/3 (134 sheets): 0 failures
  - ❌ Git commit: Failed due to missing `staging-sheets/` directory

**Key Insight:** Authentication was fully resolved! All 404 production sheets were successfully snapshotted. The only failure was the git commit trying to add a non-existent directory.

### Test Run 2 (Workflow Run ID: 19246692331)
- **Status:** Currently running
- **Expected:** Complete success

## Credentials Format

The `CLASP_CREDENTIALS` GitHub secret contains the full `.clasprc.json` structure with nested tokens:

```json
{
  "tokens": {
    "default": {
      "client_id": "...",
      "client_secret": "...",
      "type": "authorized_user",
      "refresh_token": "...",
      "access_token": "..."
    }
  }
}
```

This format is generated by `clasp login` and includes:
- OAuth client credentials
- Access token (expires after ~1 hour)
- Refresh token (long-lived, used to get new access tokens)

## Previous Fixes Attempted (From Earlier Sessions)

1. **Removed `package-lock.json` from `.gitignore`** - GitHub Actions needs lock file for npm cache
2. **Added workflow permissions** - Added `contents: write` and `issues: write`
3. **Created `CLASP_CREDENTIALS` secret** - Stored clasp credentials as GitHub secret
4. **Fixed hardcoded clasp path** - Changed `/usr/local/bin/clasp` to `npx clasp`
5. **Implemented batch processing** - Split 404 sheets into 3 batches of ~135 each to avoid token timeout

## Batch Processing Strategy

To handle OAuth token expiration concerns, the workflow processes sheets in 3 batches:

- **Batch 1/3:** Sheets 0-134 (135 sheets) - ~10 minutes
- **Batch 2/3:** Sheets 135-269 (135 sheets) - ~10 minutes
- **Batch 3/3:** Sheets 270-403 (134 sheets) - ~10 minutes

**Total Time:** ~30 minutes for all production sheets

## Files Modified

1. `.github/workflows/daily-snapshots.yml`
   - Added `.clasprc.json` write to project directory (commit 665ed55)
   - Fixed git add to handle missing staging directory (commit c473c5a)

## Success Metrics

**Before Fix:**
- Workflow failed within seconds with authentication error on sheet-000

**After Fix:**
- Workflow successfully snapshots all 404 production sheets
- All 3 batches complete with 0 failures
- Total duration: ~23-25 minutes

## Recommendations

### Short-term
The current solution using user account OAuth credentials works well for automated snapshots.

### Long-term
Consider migrating to a Google Cloud Service Account for:
- **True permanence:** Service accounts don't have refresh token expiration
- **Better security:** Can scope permissions precisely
- **Team independence:** Not tied to individual user account
- **HIPAA compliance:** Clearer audit trail for PHI access

## Monitoring

The workflow runs twice daily:
- 9:00 AM PST (5:00 PM UTC)
- 5:00 PM PST (1:00 AM UTC next day)

Manual triggers are also supported via GitHub Actions UI or:
```bash
gh workflow run daily-snapshots.yml
```

## Related Documentation

- Previous summary: `GITHUB-ACTIONS-FIX-SUMMARY.md`
- Batch processing changes: commit 3778a4d
- Credential path fix: commit 665ed55
- Git add fix: commit c473c5a

