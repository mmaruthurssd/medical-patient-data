<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8">
    <title>Sheets Directory</title>
    <style>
      :root{
        --container:1200px;
        --header-bg:#0f3d8a;
        --text:#0f172a; --bg:#f6f7fb; --card-bg:#ffffff; --border:#e5e7eb;
        --muted:#6b7280; --primary:#2f68ff; --seg-bg:#f3f4f6; --seg-active:#e6ecff;
        --header-h:160px; /* updated at runtime */
      }
      body.theme-dark{
        --text:#e6edf3; --bg:#0b1220; --card-bg:#111827; --border:#253047;
        --muted:#a6b3c5; --seg-bg:#1b263b; --seg-active:#223155;
      }
      html,body{height:100%}
      body{margin:0;background:var(--bg);color:var(--text);font-family:Arial,sans-serif}
      .container{max-width:var(--container);margin:0 auto;padding:0 16px}

      header{position:fixed;left:0;right:0;top:0;z-index:9999;background:var(--header-bg);color:#fff;box-shadow:0 2px 0 rgba(0,0,0,.08)}
      .toolbar{display:grid;grid-template-rows:auto auto auto auto;gap:10px;padding:14px 0}

      /* Increased breathing room below the sticky header */
      main{padding:calc(var(--header-h) + 96px) 0 28px}

      /* BRANDING row */
      .brand{display:flex;justify-content:center;align-items:center;gap:16px}
      .brand img{display:block;height:auto;max-height:calc(var(--header-h) / 2.6667)} /* logo 50% bigger than original */
      .brand-title{color:#fff;font-weight:800;letter-spacing:.08em;text-transform:uppercase;font-size:clamp(18px,2.4vw,32px)} /* title 50% smaller */

      .search-wrap{display:flex;justify-content:center}
      .search input{width:min(900px,82vw);padding:12px 14px;border:1px solid rgba(255,255,255,.3);border-radius:12px;font-size:14px;color:#0f172a;background:#fff;outline:none}

      .controlbar{display:flex;gap:12px;align-items:center;justify-content:space-between}
      .left-controls{display:flex;gap:10px;align-items:center}
      .right-controls{display:flex;gap:12px;align-items:center}
      .control-label{color:#cfe1ff;font-size:13px}
      select.control{appearance:none;padding:8px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.25);background:#fff;color:#0f172a;min-width:200px}
      .seg{display:inline-flex;background:var(--seg-bg);padding:2px;border-radius:12px}
      .seg button{padding:8px 12px;border:0;background:transparent;cursor:pointer;border-radius:10px;color:var(--text)}
      .seg button.active{background:var(--seg-active);font-weight:600}
      .btn{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.25);background:#fff;color:#0f172a;cursor:pointer}
      .btn.dark{background:#192c59;color:#fff;border-color:rgba(255,255,255,.25)}
      .btn.dark.active{outline:2px solid rgba(255,255,255,.35)}
      .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}

      .filters-wrap{display:none;justify-content:center}
      .filters{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
      .section-title{font-size:14px;font-weight:bold;color:#fff}

      .ms-wrap{position:relative}
      .ms-button{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid rgba(255,255,255,.25);border-radius:10px;background:#fff;cursor:pointer;color:#0f172a}
      .ms-badge{font-size:12px;background:#eef3ff;padding:2px 6px;border-radius:8px}

      .ms-panel{position:absolute;top:calc(100% + 6px);left:0;min-width:300px;border:1px solid var(--border);border-radius:12px;background:var(--card-bg);box-shadow:0 8px 24px rgba(0,0,0,.12);display:none;z-index:10000;display:grid;grid-template-rows:auto 1fr auto;overflow:hidden}
      .ms-header{border-bottom:1px solid var(--border);background:var(--card-bg)}
      .ms-row{display:flex;align-items:center;justify-content:space-between;padding:10px 12px}
      .ms-row + .ms-row{border-top:1px solid var(--border)}
      .ms-row label{display:flex;align-items:center;gap:8px;cursor:pointer;color:var(--text)}
      .count-pill{font-size:11px;padding:2px 6px;border:1px solid var(--border);border-radius:10px;background:var(--bg);color:var(--muted)}
      .ms-list{overflow-y:auto;max-height:340px;background:var(--card-bg)}
      .ms-actions{display:flex;gap:8px;padding:10px 12px;border-top:1px solid var(--border);background:var(--card-bg)}

      .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
      .cards.list{grid-template-columns:1fr}
      .card{border:1px solid var(--border);border-radius:12px;padding:12px;background:var(--card-bg)}
      .card h3{margin:0 0 8px 0;font-size:16px}
      .card h3 a{color:var(--primary);text-decoration:none}
      .muted{color:var(--muted);font-size:12px}
      .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
      .chip{font-size:11px;padding:3px 8px;border:1px solid var(--border);border-radius:12px;background:var(--bg);color:var(--text)}
      .empty{text-align:center;color:var(--muted);padding:40px 10px;border:2px dashed var(--border);border-radius:12px;background:var(--card-bg)}
    </style>
  </head>
  <body>
    <header id="appHeader">
      <div class="container">
        <div class="toolbar">
          <!-- BRAND -->
          <div class="brand">
            <img id="brandLogo" alt="Logo" style="display:none;">
            <span id="brandTitle" class="brand-title">SSD INTRANET</span>
          </div>

          <!-- SEARCH -->
          <div class="search-wrap">
            <div class="search">
              <input id="searchInput" type="text" placeholder="Search by name or description…">
            </div>
          </div>

          <!-- CONTROLS -->
          <div class="controlbar">
            <div class="left-controls">
              <button id="filtersToggle" class="btn dark" aria-pressed="true">Filters</button>
            </div>
            <div class="right-controls">
              <span class="control-label">Sort:</span>
              <select id="sortSelect" class="control">
                <option value="name_asc">Name (A→Z)</option>
                <option value="name_desc">Name (Z→A)</option>
              </select>
              <div class="seg" id="viewSeg">
                <button id="listBtn" class="active" title="List">List</button>
                <button id="gridBtn" title="Grid">Grid</button>
              </div>
              <button id="themeBtn" class="btn dark" title="Toggle dark mode">Dark</button>
            </div>
          </div>

          <!-- FILTERS ROW -->
          <div class="filters-wrap" id="filtersRow">
            <div class="filters">
              <span class="section-title">Teams:</span>
              <div class="ms-wrap" id="teamMs">
                <button class="ms-button" id="teamBtn">
                  <span id="teamBtnLabel">All Teams</span>
                  <span class="ms-badge" id="teamBtnCount">0 selected</span>
                </button>
                <div class="ms-panel" id="teamPanel">
                  <div class="ms-header">
                    <div class="ms-row">
                      <label><input type="checkbox" id="teamAll"> <strong>All</strong></label>
                      <span class="count-pill" id="teamAllCount">0</span>
                    </div>
                  </div>
                  <div class="ms-list" id="teamList"></div>
                  <div class="ms-actions">
                    <button class="btn" id="teamClear">Clear</button>
                    <button class="btn primary" id="teamApply">Apply</button>
                  </div>
                </div>
              </div>

              <span class="section-title">Categories:</span>
              <div class="ms-wrap" id="catMs">
                <button class="ms-button" id="catBtn">
                  <span id="catBtnLabel">All Categories</span>
                  <span class="ms-badge" id="catBtnCount">0 selected</span>
                </button>
                <div class="ms-panel" id="catPanel">
                  <div class="ms-header">
                    <div class="ms-row">
                      <label><input type="checkbox" id="catAll"> <strong>All</strong></label>
                      <span class="count-pill" id="catAllCount">0</span>
                    </div>
                  </div>
                  <div class="ms-list" id="catList"></div>
                  <div class="ms-actions">
                    <button class="btn" id="catClear">Clear</button>
                    <button class="btn primary" id="catApply">Apply</button>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>
    </header>

    <main>
      <div class="container">
        <div id="cards" class="cards list"></div>
        <div id="empty" class="empty" style="display:none;">No results match your filters.</div>
      </div>
    </main>

    <script>
      // ---------- State ----------
      let ALL_ENTRIES=[]; 
      let FACETS={total:0,teams:[],categories:[]};
      let selectedTeams=new Set();
      let selectedCategories=new Set();
      let searchText='';
      let sortMode='name_asc';
      let viewMode='list';
      let filtersVisible=true;

      // ---------- Layout helpers ----------
      function setHeaderOffset(){
        const hdr=document.getElementById('appHeader');
        const h=hdr.getBoundingClientRect().height;
        document.documentElement.style.setProperty('--header-h',h+'px');
        const logo=document.getElementById('brandLogo');
        if(logo && logo.style.display!=='none'){ logo.style.maxHeight=Math.floor(h/2.6667)+'px'; }
      }

      function el(t,a={},c=[]){
        const n=document.createElement(t);
        Object.entries(a).forEach(([k,v])=>{
          if(k==='class') n.className=v;
          else if(k==='html') n.innerHTML=v;
          else n.setAttribute(k,v);
        });
        (Array.isArray(c)?c:[c]).forEach(x=>x&&n.appendChild(typeof x==='string'?document.createTextNode(x):x));
        return n;
      }

      function normalizeCats(e){ return Array.isArray(e?.categories)&&e.categories.length?e.categories:(Array.isArray(e?.cats)?e.cats:[]) }
      function getEntryTeams(e){
        const raw=(e.team||'Unassigned').trim()||'Unassigned';
        const list=raw.split(',').map(t=>t.trim()).filter(Boolean);
        return list.length?list:['Unassigned'];
      }

      function sortEntries(a){
        const b=[...a];
        if(sortMode==='name_asc') b.sort((x,y)=>(x.name||'').localeCompare(y.name||''));
        if(sortMode==='name_desc') b.sort((x,y)=>(y.name||'').localeCompare(x.name||''));
        return b;
      }

      function applyFilters(){
        const teamsActive=selectedTeams.size>0, catsActive=selectedCategories.size>0;

        const filtered=ALL_ENTRIES.filter(e=>{
          const rowTeams=getEntryTeams(e);
          const teamOk=!teamsActive||rowTeams.some(t=>selectedTeams.has(t));
          const cats=normalizeCats(e);
          const catOk=!catsActive||cats.some(c=>selectedCategories.has(c));
          const textOk=!searchText||((e.name&&e.name.toLowerCase().includes(searchText))||(e.desc&&e.desc.toLowerCase().includes(searchText)));
          return teamOk&&catOk&&textOk;
        });

        renderCards(sortEntries(filtered));
      }

      function renderCards(entries){
        const cardsEl=document.getElementById('cards'), emptyEl=document.getElementById('empty');
        cardsEl.classList.toggle('list',viewMode==='list'); 
        cardsEl.classList.toggle('grid',viewMode==='grid');

        cardsEl.innerHTML='';
        if(!entries.length){ emptyEl.style.display=''; return; }
        emptyEl.style.display='none';

        entries.forEach(e=>{
          const cats=normalizeCats(e);
          const card=el('div',{class:'card'},[
            el('h3',{},[el('a',{href:e.url||e.link,target:'_blank'},e.name||'Untitled')]),
            el('div',{class:'muted'},e.desc||e.tabName||''),
            el('div',{class:'chips'},[
              ...getEntryTeams(e).map(t=>el('span',{class:'chip'},t)),
              ...cats.map(c=>el('span',{class:'chip'},c))
            ])
          ]);
          cardsEl.appendChild(card);
        });
      }

      function wireDropdown({wrapId,btnId,panelId,allChkId,allCountId,listId,clearId,applyId,facets,selectionSet,emptyLabel}){
        const btn=document.getElementById(btnId), panel=document.getElementById(panelId), allChk=document.getElementById(allChkId),
              allCount=document.getElementById(allCountId), list=document.getElementById(listId),
              clearBtn=document.getElementById(clearId), applyBtn=document.getElementById(applyId),
              btnLabel=btn.querySelector('span:first-child'), btnCount=btn.querySelector('.ms-badge');

        list.innerHTML=''; 
        allCount.textContent=String(FACETS.total);

        facets.forEach(({name,count})=>{
          const id=wrapId+'_'+name.replace(/\W+/g,'_');
          list.appendChild(el('div',{class:'ms-row'},[
            el('label',{for:id},[el('input',{type:'checkbox',id}),name]),
            el('span',{class:'count-pill'},String(count))
          ]));
        });

        btn.onclick=()=>{panel.style.display=(panel.style.display==='block'?'none':'block')};
        document.addEventListener('click',(e)=>{if(!panel.contains(e.target)&&!btn.contains(e.target))panel.style.display='none'});

        allChk.checked=selectionSet.size===0;
        allChk.onchange=()=>{ if(allChk.checked) list.querySelectorAll('input[type="checkbox"]').forEach(c=>c.checked=false); };

        clearBtn.onclick=()=>{ 
          selectionSet.clear();
          list.querySelectorAll('input[type="checkbox"]').forEach(c=>c.checked=false);
          allChk.checked=true; btnLabel.textContent=emptyLabel; btnCount.textContent='0 selected';
          applyFilters(); setHeaderOffset();
        };

        applyBtn.onclick=()=>{ 
          selectionSet.clear();
          const checks=list.querySelectorAll('input[type="checkbox"]');
          checks.forEach((c,idx)=>{ if(c.checked) selectionSet.add(facets[idx].name); });
          allChk.checked=selectionSet.size===0;

          if(selectionSet.size===0){ btnLabel.textContent=emptyLabel; btnCount.textContent='0 selected'; }
          else if(selectionSet.size===1){ const only=[...selectionSet][0]; btnLabel.textContent=only; btnCount.textContent='1 selected'; }
          else { btnLabel.textContent=[...selectionSet].slice(0,2).join(', ') + (selectionSet.size>2?'…':''); btnCount.textContent=`${selectionSet.size} selected`; }

          panel.style.display='none';
          applyFilters(); 
          setHeaderOffset();
        };
      }

      function updateFiltersVisibility(){
        const filtersRow=document.getElementById('filtersRow');
        const toggle=document.getElementById('filtersToggle');
        filtersRow.style.display = filtersVisible ? 'flex' : 'none';
        toggle.classList.toggle('active', filtersVisible);
        toggle.setAttribute('aria-pressed', filtersVisible ? 'true' : 'false');
        // Close any open dropdown panels when hiding
        if(!filtersVisible){
          const teamPanel=document.getElementById('teamPanel');
          const catPanel=document.getElementById('catPanel');
          if(teamPanel) teamPanel.style.display='none';
          if(catPanel) catPanel.style.display='none';
        }
        setHeaderOffset();
        // remember choice
        try { localStorage.setItem('dir_filters_visible', filtersVisible ? '1' : '0'); } catch(_){}
      }

      window.addEventListener('DOMContentLoaded',()=>{
        // theme
        try {
          const savedTheme=localStorage.getItem('dir_theme'); 
          if(savedTheme==='dark') document.body.classList.add('theme-dark');
          const savedFilters=localStorage.getItem('dir_filters_visible');
          if(savedFilters!==null) filtersVisible = savedFilters === '1';
        } catch(_){}

        // initial layout
        setHeaderOffset(); 
        window.addEventListener('resize',setHeaderOffset); 
        window.addEventListener('load',setHeaderOffset);

        // branding
        google.script.run.withSuccessHandler(({title,logoDataUrl}={})=>{
          const titleEl=document.getElementById('brandTitle'), logoEl=document.getElementById('brandLogo');
          if(title) titleEl.textContent=String(title).toUpperCase();
          if(logoDataUrl){ logoEl.src=logoDataUrl; logoEl.style.display=''; }
          setHeaderOffset();
        }).getBranding();

        // search
        document.getElementById('searchInput').addEventListener('input',(e)=>{
          searchText=(e.target.value||'').trim().toLowerCase();
          applyFilters();
        });

        // sort/view/theme
        const sortSelect=document.getElementById('sortSelect');
        sortSelect.addEventListener('change',()=>{sortMode=sortSelect.value;applyFilters()});
        const listBtn=document.getElementById('listBtn'), gridBtn=document.getElementById('gridBtn');
        const updateView=()=>{listBtn.classList.toggle('active',viewMode==='list');gridBtn.classList.toggle('active',viewMode==='grid')};
        listBtn.onclick=()=>{viewMode='list';updateView();applyFilters()};
        gridBtn.onclick=()=>{viewMode='grid';updateView();applyFilters()};
        document.getElementById('themeBtn').onclick=()=>{document.body.classList.toggle('theme-dark');try{localStorage.setItem('dir_theme',document.body.classList.contains('theme-dark')?'dark':'light')}catch(_){}};

        // filters toggle (now truly toggles)
        const filtersToggle=document.getElementById('filtersToggle');
        filtersToggle.onclick=()=>{ filtersVisible = !filtersVisible; updateFiltersVisibility(); };
        updateFiltersVisibility(); // set initial state

        // data
        google.script.run.withSuccessHandler(e=>{ALL_ENTRIES=Array.isArray(e)?e:[];applyFilters()}).getDirectoryDataForViewer();
        google.script.run.withSuccessHandler(f=>{
          FACETS=f||{total:0,teams:[],categories:[]};
          wireDropdown({wrapId:'teamMs',btnId:'teamBtn',panelId:'teamPanel',allChkId:'teamAll',allCountId:'teamAllCount',listId:'teamList',clearId:'teamClear',applyId:'teamApply',facets:FACETS.teams,selectionSet:selectedTeams,emptyLabel:'All Teams'});
          wireDropdown({wrapId:'catMs',btnId:'catBtn',panelId:'catPanel',allChkId:'catAll',allCountId:'catAllCount',listId:'catList',clearId:'catClear',applyId:'catApply',facets:FACETS.categories,selectionSet:selectedCategories,emptyLabel:'All Categories'});
          setHeaderOffset(); 
          applyFilters();
        }).getFacetsForViewer();
      });
    </script>
  </body>
</html>
