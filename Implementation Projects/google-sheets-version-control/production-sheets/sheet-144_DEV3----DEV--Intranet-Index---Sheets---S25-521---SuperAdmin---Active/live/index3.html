<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sheets Directory</title>

<!-- Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Material+Symbols+Outlined" rel="stylesheet">

<style>
  /* =========
     THEME TOKENS
     ========= */
  :root {
    --bg: #f7f7fb;
    --card: #fff;
    --text: #1f2937;
    --muted: #6b7280;
    --line: #e7e7ee;
    --brand: #2563eb;
    --chip: #eef2ff;
    --sidebar-bg: #ffffff;
    --sidebar-border: #e7e7ee;
    --active: #1f2937;
  }

  /* Reset-ish */
  * { box-sizing: border-box; }
  body {
    margin: 0;
    background: var(--bg);
    color: var(--text);
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }

  /* =========
     HEADER (sticky, search, sort, view toggle)
     ========= */
  header {
    position: sticky; top: 0; z-index: 20;
    background: linear-gradient(var(--bg), rgba(247,247,251,0.75));
    backdrop-filter: saturate(180%) blur(6px);
    border-bottom: 1px solid var(--line);
  }
  .wrap { max-width: 1200px; margin: 0 auto; padding: 14px 18px; }
  .title { font-weight: 600; font-size: 20px; margin-bottom: 10px; }

  /* Controls row: search + right controls (sort + view toggle) */
  .controls {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 10px;
    align-items: center;
  }

  /* Right side controls become a small cluster */
  .right-controls { display: flex; gap: 8px; align-items: center; }

  input[type="search"], select {
    width: 100%; padding: 11px 12px;
    border: 1px solid #ddd; border-radius: 10px; background: #fff;
    font-size: 14px; outline: none;
  }

  /* Toggle group (List vs Tiles) */
  .toggle {
    display: inline-flex; border: 1px solid var(--line); border-radius: 10px; overflow: hidden;
    background: #fff;
  }
  .toggle button {
    appearance: none; border: 0; background: transparent; padding: 8px 10px;
    cursor: pointer; font-size: 13px; display: inline-flex; align-items: center; gap: 6px;
  }
  .toggle button.active { background: #eef2ff; color: var(--active); font-weight: 600; }
  .ic { font-family: 'Material Symbols Outlined'; font-variation-settings: 'OPSZ' 20; font-size: 18px; }

  .meta { margin-top: 8px; font-size: 12px; color: var(--muted); }

  /* =========
     LAYOUT (sidebar + main content)
     ========= */
  .layout {
    max-width: 1200px; margin: 0 auto; padding: 16px 18px 32px;
    display: grid; gap: 18px; grid-template-columns: 260px 1fr; align-items: start;
  }

  /* Sidebar: categories */
  .sidebar {
    position: sticky; top: 70px;
    background: var(--sidebar-bg); border: 1px solid var(--sidebar-border);
    border-radius: 12px; padding: 10px;
  }
  .side-heading { font-weight: 600; font-size: 13px; color: var(--muted); padding: 8px 10px; }
  .side-actions { display: none; gap: 8px; padding: 0 10px 8px; }
  .btn-ghost {
    border: 1px solid var(--sidebar-border); background: #fff; border-radius: 10px; padding: 8px 10px; font-size: 13px; cursor: pointer;
  }

  .cat-list { list-style: none; padding: 0; margin: 6px 0 0; }
  .cat-item {
    display: flex; align-items: center; justify-content: space-between; gap: 8px;
    padding: 8px 10px; border-radius: 10px; cursor: pointer; user-select: none;
  }
  .cat-item:hover { background: #f4f6ff; }
  .cat-item.active { background: #e8edff; color: var(--active); font-weight: 600; }
  .badge {
    font-variant-numeric: tabular-nums;
    background: #f2f2f7; border: 1px solid #e7e7ee; border-radius: 999px; padding: 2px 8px; font-size: 12px;
  }

  /* =========
     LIST VIEW (original style)
     ========= */
  .list { display: flex; flex-direction: column; gap: 10px; margin-top: 6px; }
  .item {
    background: var(--card); border: 1px solid var(--line); border-radius: 14px;
    padding: 14px; display: flex; flex-wrap: wrap; gap: 12px; justify-content: space-between;
  }
  .item-main { min-width: 240px; flex: 1 1 520px; }
  .item h3 { margin: 0 0 6px 0; font-size: 16px; line-height: 1.3; }
  .item h3 a { color: var(--text); text-decoration: none; }
  .item h3 a:hover { text-decoration: underline; }
  .desc { color: var(--muted); font-size: 13px; margin-top: 4px; }
  .row { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--muted); flex-wrap: wrap; margin-top: 8px; }

  .chip {
    display: inline-flex; align-items: center; gap: 6px;
    background: var(--chip); border: 1px solid #e6e6ff; padding: 4px 8px; border-radius: 999px; font-size: 12px;
  }
  .chips { display: flex; gap: 6px; flex-wrap: wrap; }

  .actions { display: flex; align-items: center; gap: 10px; }
  .btn {
    appearance: none; border: 1px solid var(--brand); background: var(--brand); color: white;
    padding: 9px 12px; border-radius: 10px; font-weight: 600; font-size: 13px; cursor: pointer;
    text-decoration: none; display: inline-flex; align-items: center; gap: 6px;
  }
  .btn.secondary { background: #fff; color: var(--brand); }

  /* =========
     TILE VIEW (new)
     ========= */
  .grid { /* container for tiles */
    display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 12px; margin-top: 6px;
  }
  @media (max-width: 1000px) { .grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
  @media (max-width: 640px) { .grid { grid-template-columns: 1fr; } }

  .tile {
    background: var(--card); border: 1px solid var(--line); border-radius: 14px; padding: 14px;
    display: flex; flex-direction: column; gap: 10px;
  }
  .tile-title { font-weight: 600; line-height: 1.3; }
  .tile-title a { color: var(--text); text-decoration: none; }
  .tile-title a:hover { text-decoration: underline; }
  .tile-desc { color: var(--muted); font-size: 13px; min-height: 34px; }
  .tile-meta { display: flex; gap: 6px; flex-wrap: wrap; }
  .tile-actions { margin-top: 6px; display: flex; justify-content: space-between; gap: 8px; }

  /* Misc */
  .empty { text-align: center; color: var(--muted); padding: 40px 0; }
  .footer-note { margin-top: 18px; color: var(--muted); font-size: 12px; }

  /* Mobile tweaks */
  @media (max-width: 760px)  {
    .layout { grid-template-columns: 1fr; }
    .sidebar { position: static; }
    .side-actions { display: flex; }
  }
</style>
</head>

<body>
  <!-- =========
       HEADER
       ========= -->
  <header>
    <div class="wrap">
      <div class="title">Sheets Directory</div>

      <!-- Controls: search on the left; sort + view toggle on the right -->
      <div class="controls">
        <input id="q" type="search" placeholder="Search by name, description, tags… (try tag:budget or cat:Operations)" />

        <div class="right-controls">
          <select id="sort" aria-label="Sort">
            <option value="name">Sort: Name (A→Z)</option>
          </select>
          <!-- View toggle (List / Tiles) -->
          <div class="toggle" role="tablist" aria-label="View toggle">
            <button id="btnList" class="active" role="tab" aria-selected="true" title="List view">
              <span class="ic">view_list</span><span class="hide-sm">List</span>
            </button>
            <button id="btnTiles" role="tab" aria-selected="false" title="Tile view">
              <span class="ic">grid_view</span><span class="hide-sm">Tiles</span>
            </button>
          </div>
        </div>
      </div>

      <div id="meta" class="meta"></div>
    </div>
  </header>

  <!-- =========
       MAIN LAYOUT
       ========= -->
  <main class="layout">
    <!-- Sidebar: categories -->
    <aside class="sidebar">
      <div class="side-heading">Categories</div>
      <div class="side-actions">
        <button class="btn-ghost" id="toggleCats">Show/Hide</button>
      </div>
      <ul id="catList" class="cat-list" aria-label="Categories"></ul>
    </aside>

    <!-- Content: list OR tiles (we mount one at a time) -->
    <section>
      <div id="mount"></div>
      <div id="empty" class="empty" style="display:none;">No matches. Try removing filters or changing your search.</div>
      <div class="footer-note">Tip: Use <b>tag:budget</b> or <b>cat:Operations</b> in the search box for quick filters.</div>
    </section>
  </main>

<script>
/* ===========================================================
   STATE & UTILITIES
   =========================================================== */
let DATA = [];           // raw items from server
let filtered = [];       // items after applying filters
let selectedCategory = '';// '' means All
let viewMode = 'list';   // 'list' | 'tiles'

/* Small helpers */
function escapeHtml(s){return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;");}
function uniq(a){return Array.from(new Set(a.filter(Boolean))).sort((x,y)=>x.localeCompare(y));}

/* URL param helpers for deep-linking/filter persistence */
function getParam(name){
  const p = new URLSearchParams(location.search);
  return p.get(name) || '';
}
function setParam(name, value){
  const p = new URLSearchParams(location.search);
  if (value) p.set(name, value); else p.delete(name);
  history.replaceState({}, '', `${location.pathname}?${p.toString()}`);
}

/* Category tally */
function buildCategoryCounts(items){
  const counts = {};
  for (const d of items) {
    const cats = (Array.isArray(d.cats) && d.cats.length) ? d.cats : ['General'];
    for (const c of cats) counts[c] = (counts[c] || 0) + 1;
  }
  return counts;
}

/* ===========================================================
   SIDEBAR RENDER + INTERACTION
   =========================================================== */
function renderSidebar() {
  const ul = document.getElementById('catList');
  ul.innerHTML = '';
  const counts = buildCategoryCounts(DATA);
  const cats = ['All', ...uniq(Object.keys(counts))];

  for (const c of cats) {
    const li = document.createElement('li');
    const isActive = (c === 'All' && !selectedCategory) || (c !== 'All' && c === selectedCategory);
    li.className = 'cat-item' + (isActive ? ' active' : '');
    li.tabIndex = 0;
    li.role = 'button';
    li.dataset.cat = c === 'All' ? '' : c;

    const label = document.createElement('span');
    label.textContent = c;

    const badge = document.createElement('span');
    badge.className = 'badge';
    badge.textContent = c === 'All' ? DATA.length : (counts[c] || 0);

    li.appendChild(label);
    li.appendChild(badge);

    li.addEventListener('click', () => {
      selectedCategory = li.dataset.cat;
      setParam('cat', selectedCategory);
      highlightActiveCategory();
      applyFilters();
      if (window.innerWidth < 760) window.scrollTo({ top: 0, behavior: 'smooth' });
    });
    li.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); li.click(); }
    });

    ul.appendChild(li);
  }

  /* mobile show/hide */
  const t = document.getElementById('toggleCats');
  if (t) {
    t.onclick = () => {
      const list = document.getElementById('catList');
      list.style.display = (list.style.display === 'none') ? '' : 'none';
    }
  }
}

function highlightActiveCategory() {
  document.querySelectorAll('.cat-item').forEach(el => {
    const cat = el.dataset.cat || '';
    const isActive = (cat === selectedCategory) || (!cat && !selectedCategory);
    if (isActive) el.classList.add('active'); else el.classList.remove('active');
  });
}

/* ===========================================================
   VIEW TOGGLING (List <-> Tiles) + PERSISTENCE
   =========================================================== */
function setView(mode) {
  viewMode = mode;
  // Reflect state in URL and localStorage
  setParam('view', mode);
  try { localStorage.setItem('sheets_dir_view', mode); } catch (e) { /* ignore */ }

  // Toggle button UI state + ARIA
  const btnList = document.getElementById('btnList');
  const btnTiles = document.getElementById('btnTiles');
  btnList.classList.toggle('active', mode === 'list');
  btnTiles.classList.toggle('active', mode === 'tiles');
  btnList.setAttribute('aria-selected', mode === 'list' ? 'true' : 'false');
  btnTiles.setAttribute('aria-selected', mode === 'tiles' ? 'true' : 'false');

  // Re-render current filtered items in requested view
  render();
}

/* ===========================================================
   RENDERERS
   =========================================================== */

/* Mount helper: swap content root cleanly */
function getMount() {
  const mount = document.getElementById('mount');
  mount.innerHTML = '';
  return mount;
}

/* LIST view renderer (original cards) */
function renderListView(items) {
  const mount = getMount();
  const list = document.createElement('div');
  list.className = 'list';

  for (const d of items) {
    const item = document.createElement('div');
    item.className = 'item';

    // Left: title + description + chips
    const main = document.createElement('div');
    main.className = 'item-main';

    const h3 = document.createElement('h3');
    const link = document.createElement('a');
    link.href = d.url; link.target = '_blank'; link.rel = 'noopener';
    link.textContent = d.name || '(untitled)';
    h3.appendChild(link);
    main.appendChild(h3);

    if (d.desc) {
      const p = document.createElement('div');
      p.className = 'desc';
      p.textContent = d.desc;
      main.appendChild(p);
    }

    // Categories + tags
    const metaRow = document.createElement('div');
    metaRow.className = 'row chips';
    const cats = (Array.isArray(d.cats) && d.cats.length) ? d.cats : ['General'];
    for (const c of cats) {
      const span = document.createElement('span'); span.className = 'chip';
      span.innerHTML = `<span class="ic">folder</span>${escapeHtml(c)}`;
      metaRow.appendChild(span);
    }
    if (d.tags?.length) {
      for (const t of d.tags) {
        const span = document.createElement('span'); span.className = 'chip';
        span.textContent = t;
        metaRow.appendChild(span);
      }
    }
    main.appendChild(metaRow);

    // Right: actions
    const actions = document.createElement('div');
    actions.className = 'actions';
    const a = document.createElement('a');
    a.className = 'btn'; a.href = d.url; a.target = '_blank'; a.rel = 'noopener';
    a.innerHTML = `<span class="ic">open_in_new</span>View`;
    actions.appendChild(a);

    item.appendChild(main);
    item.appendChild(actions);
    list.appendChild(item);
  }

  mount.appendChild(list);
}

/* TILE view renderer (compact grid) */
function renderTileView(items) {
  const mount = getMount();
  const grid = document.createElement('div');
  grid.className = 'grid';

  for (const d of items) {
    const tile = document.createElement('div');
    tile.className = 'tile';

    // Title
    const title = document.createElement('div');
    title.className = 'tile-title';
    title.innerHTML = `<a href="${d.url}" target="_blank" rel="noopener">${escapeHtml(d.name || '(untitled)')}</a>`;
    tile.appendChild(title);

    // Optional description (short)
    if (d.desc) {
      const desc = document.createElement('div');
      desc.className = 'tile-desc';
      desc.textContent = d.desc;
      tile.appendChild(desc);
    }

    // Categories + tags (chips)
    const meta = document.createElement('div');
    meta.className = 'tile-meta';
    const cats = (Array.isArray(d.cats) && d.cats.length) ? d.cats : ['General'];
    for (const c of cats) {
      const span = document.createElement('span'); span.className = 'chip';
      span.innerHTML = `<span class="ic">folder</span>${escapeHtml(c)}`;
      meta.appendChild(span);
    }
    if (d.tags?.length) {
      for (const t of d.tags) {
        const span = document.createElement('span'); span.className = 'chip';
        span.textContent = t;
        meta.appendChild(span);
      }
    }
    tile.appendChild(meta);

    // Actions
    const actions = document.createElement('div');
    actions.className = 'tile-actions';
    const viewBtn = document.createElement('a');
    viewBtn.className = 'btn';
    viewBtn.href = d.url; viewBtn.target = '_blank'; viewBtn.rel = 'noopener';
    viewBtn.innerHTML = `<span class="ic">open_in_new</span>View`;
    actions.appendChild(viewBtn);

    tile.appendChild(actions);
    grid.appendChild(tile);
  }

  mount.appendChild(grid);
}

/* Top-level render: chooses the view, manages empty state/meta */
function render() {
  const empty = document.getElementById('empty');
  empty.style.display = filtered.length ? 'none' : 'block';

  if (viewMode === 'tiles') {
    renderTileView(filtered);
  } else {
    renderListView(filtered);
  }

  document.getElementById('meta').textContent = `${filtered.length} of ${DATA.length} items`;
}

/* ===========================================================
   FILTERING & SORTING
   =========================================================== */
function applyFilters() {
  const q = document.getElementById('q').value.trim().toLowerCase();
  const sort = document.getElementById('sort').value;

  filtered = DATA.filter(d => {
    // Category filter (match any of the row's categories)
    if (selectedCategory) {
      const cats = (d.cats || []).map(x => (x || '').toLowerCase());
      if (!cats.includes(selectedCategory.toLowerCase())) return false;
    }
    if (!q) return true;

    // Power tokens: tag:, cat:   (owner: is ignored/removed)
    const tokens = q.split(/\s+/).filter(Boolean);
    for (const tok of tokens) {
      if (tok.startsWith('tag:')) {
        const t = tok.slice(4);
        const tagList = (d.tags || []).map(x => (x || '').toLowerCase());
        if (!tagList.includes(t)) return false;
      } else if (tok.startsWith('cat:')) {
        const c = tok.slice(4);
        const cats = (d.cats || []).map(x => (x || '').toLowerCase());
        if (!cats.includes(c)) return false;
      } else if (tok.startsWith('owner:')) {
        // owner no-op (kept for backwards compatibility)
        continue;
      } else {
        const hay = `${d.name} ${d.desc} ${(d.cats||[]).join(' ')} ${(d.tags||[]).join(' ')}`.toLowerCase();
        if (!hay.includes(tok)) return false;
      }
    }
    return true;
  });

  // Sorting (only by name for now)
  if (sort === 'name') {
    filtered.sort((a,b) => (a.name||'').localeCompare(b.name||''));
  }

  render();
}

/* ===========================================================
   EVENT WIRING
   =========================================================== */
document.getElementById('q').addEventListener('input', applyFilters);
document.getElementById('sort').addEventListener('change', applyFilters);
document.getElementById('btnList').addEventListener('click', () => setView('list'));
document.getElementById('btnTiles').addEventListener('click', () => setView('tiles'));

/* Keyboard shortcut: g then l (list) / g then t (tiles) */
let _gPressedAt = 0;
window.addEventListener('keydown', (e) => {
  const now = Date.now();
  if (e.key.toLowerCase() === 'g') _gPressedAt = now;
  if (now - _gPressedAt < 800) {
    if (e.key.toLowerCase() === 'l') setView('list');
    if (e.key.toLowerCase() === 't') setView('tiles');
  }
});

/* ===========================================================
   DATA LOAD (Apps Script) + INITIAL STATE
   =========================================================== */
google.script.run.withSuccessHandler(data => {
  // Normalize incoming data
  DATA = (data || []).map(d => ({
    name: d.name || '',
    url: d.url || '#',
    cats: Array.isArray(d.cats) && d.cats.length ? d.cats : ['General'],
    desc: d.desc || '',
    tags: Array.isArray(d.tags) ? d.tags : []
  }));

  renderSidebar();

  // Read persisted view from URL or localStorage (URL wins)
  const fromParamView = getParam('view');
  const fromStorageView = (() => { try { return localStorage.getItem('sheets_dir_view'); } catch(e){ return null; }})();
  setView(fromParamView === 'tiles' || fromParamView === 'list'
    ? fromParamView
    : (fromStorageView === 'tiles' || fromStorageView === 'list' ? fromStorageView : 'list')
  );

  // Read ?cat from URL if present
  const fromParamCat = getParam('cat');
  selectedCategory = fromParamCat ? fromParamCat : '';
  highlightActiveCategory();

  // Initial render
  filtered = DATA.slice();
  applyFilters();
}).getDirectoryData();
</script>
</body>
</html>
