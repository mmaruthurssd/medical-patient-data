# Google Workspace OAuth Setup Scripts

This directory contains authentication setup and deployment scripts for Google Workspace operations. These scripts handle both OAuth-based Apps Script deployments and service account operations.

## Scripts in this Directory

### 1. **generate-oauth-token.js**
**Purpose:** Generate OAuth token with full Apps Script access

- **When to use:** Initial setup or when token has insufficient scopes
- **How to run:**
  ```bash
  node generate-oauth-token.js
  ```
- **Requires:**
  - `credentials.json` (symlinked from Google Sheets Automation Projects)
- **Generates:**
  - `token.json` with the following scopes:
    - `script.projects` (FULL access, not readonly)
    - `script.deployments`
    - `spreadsheets`
    - `drive.file`
    - `documents`
- **Process:**
  1. Opens OAuth authorization URL in browser
  2. User authorizes the application
  3. Paste authorization code into terminal
  4. Script generates `token.json` with refresh token

### 2. **deploy-dashboard-integration.js**
**Purpose:** Deploy Apps Script to existing Google Sheet

- **When to use:** Adding Apps Script automation to a sheet
- **How to run:**
  1. Edit configuration variables:
     - `SPREADSHEET_ID`: Target sheet ID
     - `SCRIPT_SOURCE_FILE`: Path to `.gs` file to deploy
  2. Run:
     ```bash
     node deploy-dashboard-integration.js
     ```
- **Requires:**
  - OAuth credentials with `script.projects` scope
  - Valid `credentials.json` and `token.json`
- **What it does:**
  1. Authenticates with OAuth (automation@ssdspc.com)
  2. Creates container-bound Apps Script project
  3. Uploads code from source file
  4. Configures project manifest (timezone, scopes, runtime)
  5. Triggers `onOpen()` to install menu
- **Note:** If sheet already has a script, you must delete it first or provide the script ID

### 3. **service-account.json** (symlink)
**Purpose:** Service Account credentials for data operations

- **When to use:**
  - Creating sheets
  - Reading/writing data
  - Applying formatting
  - Any operation that doesn't require Apps Script deployment
- **Points to:**
  ```
  /Users/mmaruthurnew/Desktop/medical-patient-data/configuration/service-accounts/service-account.json
  ```
- **Permissions:**
  - Service account email: `automation@ssdspc.com`
  - Has editor access to shared drives and folders

### 4. **credentials.json** (symlink)
**Purpose:** OAuth client credentials

- **Should point to:**
  ```
  /Users/mmaruthurnew/Desktop/Google Sheets Automation Projects/google-sheets-framework-building-and-refactoring-project/config/credentials.json
  ```
- **Required for:**
  - Apps Script operations
  - OAuth token generation
- **Contains:**
  - OAuth 2.0 Client ID
  - Client Secret
  - Redirect URIs

### 5. **token.json** (symlink or generated)
**Purpose:** OAuth access/refresh tokens

- **Generated by:** `generate-oauth-token.js`
- **Required scopes:**
  - `script.projects` (full access)
  - `script.deployments`
  - `spreadsheets`
  - `drive.file`
  - `documents`
- **Contains:**
  - Access token (short-lived)
  - Refresh token (long-lived)
  - Expiry timestamp

## Authentication Decision Tree

```
┌─────────────────────────────────────────┐
│ What do you need to do?                 │
└─────────────────────────────────────────┘
                    │
        ┌───────────┴───────────┐
        │                       │
        ▼                       ▼
┌──────────────┐        ┌──────────────┐
│ Data         │        │ Apps Script  │
│ Operations   │        │ Operations   │
└──────────────┘        └──────────────┘
        │                       │
        │                       │
        ▼                       ▼
  Use Service              Use OAuth
  Account                  Credentials
        │                       │
        │                       │
        ▼                       ▼
service-account.json    credentials.json
                        + token.json
```

### Use Service Account (`service-account.json`) for:
- Creating new sheets
- Reading/writing cell data
- Applying formatting (fonts, colors, borders)
- Creating/modifying sheet structure
- Working with formulas
- Batch operations on sheet data

### Use OAuth (`credentials.json` + `token.json`) for:
- Deploying Apps Script code
- Creating container-bound scripts
- Updating Apps Script projects
- Managing Apps Script deployments
- Accessing user-specific data

## Common Workflows

### Initial Setup (First Time)
```bash
# 1. Ensure credentials.json symlink exists
ls -l credentials.json

# 2. Generate OAuth token with correct scopes
node generate-oauth-token.js

# 3. Verify token.json was created
cat token.json
```

### Deploying Apps Script to a Sheet
```bash
# 1. Edit deploy-dashboard-integration.js
# - Set SPREADSHEET_ID
# - Set SCRIPT_SOURCE_FILE path

# 2. Run deployment
node deploy-dashboard-integration.js

# 3. Open sheet in browser to verify menu appears
```

### Regenerating Token (When Scopes Change)
```bash
# 1. Delete existing token
rm token.json

# 2. Generate new token with updated scopes
node generate-oauth-token.js
```

## Troubleshooting

### Error: "Insufficient authentication scopes"
**Problem:** Token doesn't have required scopes
**Solution:** Regenerate token with `generate-oauth-token.js`

### Error: "Sheet already has a script"
**Problem:** Trying to deploy Apps Script to sheet that already has one
**Solution:**
- Option 1: Delete existing script from sheet's Extensions > Apps Script
- Option 2: Update script ID in deployment script

### Error: "credentials.json not found"
**Problem:** Symlink is broken or file doesn't exist
**Solution:**
```bash
# Recreate symlink
ln -sf "/Users/mmaruthurnew/Desktop/Google Sheets Automation Projects/google-sheets-framework-building-and-refactoring-project/config/credentials.json" credentials.json
```

### Error: "Invalid grant" when using token
**Problem:** Refresh token expired or revoked
**Solution:** Regenerate token with `generate-oauth-token.js`

## Security Notes

- **Never commit credentials or tokens to git**
- All authentication files are symlinked to prevent duplication
- Service account has limited scope (only shared drives/folders)
- OAuth tokens are user-specific (automation@ssdspc.com)
- Tokens stored in `token.json` have refresh tokens for long-term access

## Related Documentation

- [Google Sheets Formatting Standards](/Users/mmaruthurnew/Desktop/medical-patient-data/infrastructure/GOOGLE-SHEETS-FORMATTING-STANDARDS.md)
- [Quick Operations Guide](/Users/mmaruthurnew/Desktop/medical-patient-data/QUICK-OPERATIONS-GUIDE.md)
- Service Account Setup: `/Users/mmaruthurnew/Desktop/medical-patient-data/configuration/service-accounts/README.md`

## Package Dependencies

This directory uses the following npm packages:

```json
{
  "googleapis": "^143.0.0"
}
```

Install with:
```bash
npm install
```
